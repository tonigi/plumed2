name: W64 build

on:
  push:
  pull_request:


jobs:
  # Build master
  w64-conda-build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - uses: conda-incubator/setup-miniconda@v2
      with:
        miniforge-version: latest
    - run: conda info
    - run: conda install conda-build
    - run: conda build conda/w64
    - uses: actions/upload-artifact@v3
      with:
        name: plumed-master.tar.bz2
        path: C:\Miniconda3\envs\test\conda-bld\win-64\plumed-2.8-testing.tar.bz2

  # Regtest master just built
  w64-regtest:
    needs: w64-conda-build
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - uses: conda-incubator/setup-miniconda@v2
      with:
        miniforge-version: latest
    - run: conda info
    - uses: actions/download-artifact@v3
      with:
        name: plumed-master.tar.bz2
    - run: 7z x plumed-master.tar.bz2.zip
    - run: conda install plumed-master.tar.bz2
    - run: conda install -y -c conda-forge m2-base make m2-sed m2-diffutils
    - run: make -C regtest\basic
      env: 
        PLUMED_ROOT: C:\Miniconda3\lib\plumed

  # This is like above but checks a package from conda, so starts immediately
  conda-regtest:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - uses: conda-incubator/setup-miniconda@v2
      with:
        miniforge-version: latest
    - run: conda info
#    - uses: actions/download-artifact@v3
#      with:
#        name: plumed-master.tar.bz2
#    - run: 7z x plumed-master.tar.bz2.zip
#    - run: conda install plumed-master.tar.bz2
    - run: conda install -c tonigi/label/ci plumed 
    - run: conda install -y -c conda-forge m2-base make m2-sed m2-diffutils
    - run: make -C regtest\basic
      env: 
        PLUMED_ROOT: C:\Miniconda3\lib\plumed
    - run: |
       7z a -r regtests.zip report.txt
    - uses: actions/upload-artifact@v3
      with:
        name: regtests.zip
        path: regtests.zip

        

# TODO REGTEST
    
