name: W64 build

on:
  push:
  pull_request:


jobs:
  w64-conda-build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - uses: conda-incubator/setup-miniconda@v2
      with:
        miniforge-version: latest
    - run: conda info
    - run: conda install conda-build
    - run: conda build conda/w64
    - uses: actions/upload-artifact@v3
      with:
        name: plumed-master.tar.bz2
        path: C:\Miniconda3\envs\test\conda-bld\win-64\plumed-2.8-testing.tar.bz2

  w64-regtest:
    needs: w64-conda-build
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - uses: conda-incubator/setup-miniconda@v2
      with:
        miniforge-version: latest
    - run: conda info
    - uses: actions/download-artifact@v3
      with:
        name: plumed-master.tar.bz2
    - run: 7z x plumed-master.tar.bz2.zip
    - run: conda install plumed-master.tar.bz2
    - run: conda install -y -c conda-forge m2-base make m2-sed m2-diffutils
    - run: make -C regtest\basic
      env: 
        PLUMED_ROOT: C:\Miniconda3\lib\plumed
    

# TODO REGTEST
    
